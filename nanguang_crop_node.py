"""
南光图像裁剪节点
支持九种裁剪类型，可精确控制裁剪位置和尺寸
"""

import torch
import numpy as np
from PIL import Image

class 南光图像裁剪:
    """
    南光图像裁剪节点
    支持九种裁剪类型，可精确控制裁剪位置和尺寸
    """
    
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "图像": ("IMAGE",),
                "裁剪开关": (["开启", "关闭"], {"default": "开启"}),
                "裁剪类型": (["左顶", "顶中", "右顶", "左中", "居中", "右中", "左底", "底中", "右底"], {"default": "居中"}),
                "裁剪宽度": ("INT", {"default": 512, "min": 64, "max": 4096, "step": 8}),
                "裁剪高度": ("INT", {"default": 512, "min": 64, "max": 4096, "step": 8}),
            },
            "optional": {
                "X偏移": ("INT", {"default": 0, "min": -1000, "max": 1000, "step": 1}),
                "Y偏移": ("INT", {"default": 0, "min": -1000, "max": 1000, "step": 1}),
            }
        }
    
    RETURN_TYPES = ("IMAGE", "INT", "INT", "STRING")
    RETURN_NAMES = ("裁剪图像", "宽度", "高度", "处理信息")
    FUNCTION = "执行裁剪"
    CATEGORY = "南光尺寸"
    
    def 执行裁剪(self, 图像, 裁剪开关, 裁剪类型, 裁剪宽度, 裁剪高度, X偏移=0, Y偏移=0):
        """
        执行图像裁剪操作
        """
        
        # 获取图像信息
        B, H, W, C = 图像.shape
        原始宽度 = W
        原始高度 = H
        批次大小 = B
        
        # 构建处理信息
        信息 = []
        信息.append("📊 南光图像裁剪报告")
        信息.append("=" * 40)
        信息.append(f"📐 原始尺寸: {原始宽度} × {原始高度}")
        
        # 检查裁剪开关
        if 裁剪开关 == "关闭":
            信息.append("⏹️ 裁剪功能已关闭，返回原始图像")
            信息文本 = "\n".join(信息)
            return (图像, 原始宽度, 原始高度, 信息文本)
        
        # 验证裁剪尺寸
        if 裁剪宽度 <= 0 or 裁剪高度 <= 0:
            信息.append("❌ 错误: 裁剪尺寸必须大于0")
            return (图像, 原始宽度, 原始高度, "\n".join(信息))
        
        if 裁剪宽度 > 原始宽度:
            信息.append(f"❌ 错误: 裁剪宽度({裁剪宽度})超过原始宽度({原始宽度})")
            return (图像, 原始宽度, 原始高度, "\n".join(信息))
        
        if 裁剪高度 > 原始高度:
            信息.append(f"❌ 错误: 裁剪高度({裁剪高度})超过原始高度({原始高度})")
            return (图像, 原始宽度, 原始高度, "\n".join(信息))
        
        # 计算裁剪位置
        位置映射 = {
            "左顶": (0, 0),                    # 左上角
            "顶中": ((原始宽度 - 裁剪宽度) // 2, 0),  # 顶部中间
            "右顶": (原始宽度 - 裁剪宽度, 0),         # 右上角
            "左中": (0, (原始高度 - 裁剪高度) // 2), # 左侧中间
            "居中": ((原始宽度 - 裁剪宽度) // 2, (原始高度 - 裁剪高度) // 2),  # 正中间
            "右中": (原始宽度 - 裁剪宽度, (原始高度 - 裁剪高度) // 2),  # 右侧中间
            "左底": (0, 原始高度 - 裁剪高度),       # 左下角
            "底中": ((原始宽度 - 裁剪宽度) // 2, 原始高度 - 裁剪高度),  # 底部中间
            "右底": (原始宽度 - 裁剪宽度, 原始高度 - 裁剪高度),  # 右下角
        }
        
        if 裁剪类型 not in 位置映射:
            裁剪类型 = "居中"
        
        左, 顶 = 位置映射[裁剪类型]
        
        # 应用偏移
        左 += X偏移
        顶 += Y偏移
        
        # 确保裁剪区域在图像范围内
        左 = max(0, min(左, 原始宽度 - 裁剪宽度))
        顶 = max(0, min(顶, 原始高度 - 裁剪高度))
        
        # 执行裁剪
        try:
            # 处理每张图像
            裁剪后的图像 = []
            
            for i in range(批次大小):
                # 获取单张图像
                单张图像 = 图像[i].cpu().numpy()
                
                # 转换为PIL图像
                if C == 4:  # RGBA
                    # 转换为RGB
                    单张图像 = (单张图像[..., :3] * 255).astype(np.uint8)
                    pil_img = Image.fromarray(单张图像, 'RGB')
                else:  # RGB
                    单张图像 = (单张图像 * 255).astype(np.uint8)
                    pil_img = Image.fromarray(单张图像, 'RGB')
                
                # 执行裁剪
                右 = 左 + 裁剪宽度
                底 = 顶 + 裁剪高度
                if 右 <= 原始宽度 and 底 <= 原始高度:
                    裁剪图像 = pil_img.crop((左, 顶, 右, 底))
                else:
                    信息.append("❌ 错误: 裁剪区域超出图像边界")
                    return (图像, 原始宽度, 原始高度, "\n".join(信息))
                
                # 转换回numpy数组
                裁剪数组 = np.array(裁剪图像).astype(np.float32) / 255.0
                裁剪后的图像.append(裁剪数组)
            
            # 转换为张量
            if 批次大小 == 1:
                结果张量 = torch.from_numpy(裁剪后的图像[0]).unsqueeze(0)
            else:
                结果张量 = torch.from_numpy(np.array(裁剪后的图像))
            
            # 更新信息
            信息.append("✅ 裁剪完成")
            信息.append(f"✂️ 裁剪类型: {裁剪类型}")
            信息.append(f"📏 裁剪尺寸: {裁剪宽度} × {裁剪高度}")
            信息.append(f"📍 裁剪位置: 左={左}, 顶={顶}")
            if X偏移 != 0 or Y偏移 != 0:
                信息.append(f"⚙️ 偏移调整: X={X偏移}, Y={Y偏移}")
            
            # 计算比例
            比例 = 裁剪宽度 / 裁剪高度
            比例名称 = "自定义"
            if 0.99 < 比例 < 1.01:
                比例名称 = "正方形 (1:1)"
            elif 1.32 < 比例 < 1.34:
                比例名称 = "标准 (4:3)"
            elif 0.74 < 比例 < 0.76:
                比例名称 = "竖屏 (3:4)"
            elif 1.77 < 比例 < 1.78:
                比例名称 = "宽屏 (16:9)"
            
            信息.append(f"📊 尺寸比例: {比例:.2f}:1 ({比例名称})")
            信息.append("=" * 40)
            
        except Exception as e:
            信息.append(f"❌ 裁剪过程中发生错误: {str(e)}")
            return (图像, 原始宽度, 原始高度, "\n".join(信息))
        
        处理信息 = "\n".join(信息)
        print(f"[南光尺寸] {处理信息}")
        
        return (结果张量, 裁剪宽度, 裁剪高度, 处理信息)

# ==================== 节点注册 ====================

# 节点类映射
NODE_CLASS_MAPPINGS = {
    "NanguangCrop": 南光图像裁剪,
}

# 节点显示名称映射（中文显示）
NODE_DISPLAY_NAME_MAPPINGS = {
    "NanguangCrop": "南光图像裁剪",
}

# Web扩展目录
WEB_DIRECTORY = "./web"